name: CI Guards (Delta 0014)

on:
  push:
    branches: [main, 'feature/**']
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  guards:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Install root dependencies
        run: npm install

      - name: Install frontend dependencies
        run: cd frontend && npm install

      - name: ESLint Path Guard
        id: eslint
        continue-on-error: true
        run: |
          cd frontend
          npm run lint > ../eslint.log 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Test Coverage Guard
        id: coverage
        continue-on-error: true
        run: |
          cd frontend

          # Phase 1: Skip coverage tests (not required until Phase 2)
          # Check if test directory exists with actual tests
          if [ ! -d "tests" ] || [ -z "$(find tests -name '*.test.ts' -o -name '*.test.tsx' 2>/dev/null)" ]; then
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "phase=1" >> $GITHUB_OUTPUT
            echo "message=Phase 1: Manual testing only, no automated tests required" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Phase 2+: Run coverage tests with timeout
          timeout 60s npm run test:coverage > coverage.log 2>&1 || true

          # Extract coverage percentages from output
          LINES=$(grep -oP 'All files\s+\|\s+\K[\d.]+' coverage.log | head -1 || echo "0")
          BRANCHES=$(grep -oP 'All files\s+\|\s+[\d.]+\s+\|\s+\K[\d.]+' coverage.log | head -1 || echo "0")
          FUNCTIONS=$(grep -oP 'All files\s+\|\s+[\d.]+\s+\|\s+[\d.]+\s+\|\s+\K[\d.]+' coverage.log | head -1 || echo "0")
          STATEMENTS=$(grep -oP 'All files\s+\|\s+[\d.]+\s+\|\s+[\d.]+\s+\|\s+[\d.]+\s+\|\s+\K[\d.]+' coverage.log | head -1 || echo "0")

          # Thresholds (Phase 2: 40%, Phase 3: 80%)
          LINES_THRESHOLD=40
          BRANCHES_THRESHOLD=35
          FUNCTIONS_THRESHOLD=40
          STATEMENTS_THRESHOLD=40

          # Check if all thresholds are met
          PASS=true
          [ $(echo "$LINES < $LINES_THRESHOLD" | bc -l) -eq 1 ] && PASS=false
          [ $(echo "$BRANCHES < $BRANCHES_THRESHOLD" | bc -l) -eq 1 ] && PASS=false
          [ $(echo "$FUNCTIONS < $FUNCTIONS_THRESHOLD" | bc -l) -eq 1 ] && PASS=false
          [ $(echo "$STATEMENTS < $STATEMENTS_THRESHOLD" | bc -l) -eq 1 ] && PASS=false

          echo "lines=$LINES" >> $GITHUB_OUTPUT
          echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
          echo "functions=$FUNCTIONS" >> $GITHUB_OUTPUT
          echo "statements=$STATEMENTS" >> $GITHUB_OUTPUT
          echo "phase=2" >> $GITHUB_OUTPUT

          if [ "$PASS" = true ]; then
            echo "status=pass" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "status=fail" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Performance Budget Guard
        id: perf
        continue-on-error: true
        run: |
          cd frontend
          npm run test:perf > perf.log 2>&1 || true

          # Parse metrics
          METRIC=$(grep 'PERF_METRIC:' perf.log | cut -d= -f2 || echo "0")
          THRESHOLD=$(grep 'PERF_THRESHOLD:' perf.log | awk '{print $NF}' || echo "250")
          BASELINE=150

          # Calculate delta
          DELTA=$((METRIC - BASELINE))

          # Determine pass/fail
          if [ "$METRIC" -lt "$THRESHOLD" ]; then
            echo "status=pass" >> $GITHUB_OUTPUT
            echo "metric=$METRIC" >> $GITHUB_OUTPUT
            echo "threshold=$THRESHOLD" >> $GITHUB_OUTPUT
            echo "baseline=$BASELINE" >> $GITHUB_OUTPUT
            echo "delta=$DELTA" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "status=fail" >> $GITHUB_OUTPUT
            echo "metric=$METRIC" >> $GITHUB_OUTPUT
            echo "threshold=$THRESHOLD" >> $GITHUB_OUTPUT
            echo "baseline=$BASELINE" >> $GITHUB_OUTPUT
            echo "delta=$DELTA" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Spec Path Audit Guard
        id: audit
        continue-on-error: true
        run: |
          if npm run audit:specs > audit.log 2>&1; then
            echo "status=pass" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "status=fail" >> $GITHUB_OUTPUT
            cat audit.log
            exit 1
          fi

      - name: Post Summary
        if: always()
        run: |
          echo "## Delta 0014 â€” CI Guards" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ESLint Guard Summary
          echo "### ðŸ” ESLint Path Guard" >> $GITHUB_STEP_SUMMARY
          if [ -f eslint.log ]; then
            ERROR_COUNT=$(grep -c "error" eslint.log || echo "0")
            WARN_COUNT=$(grep -c "warning" eslint.log || echo "0")

            if [ "$ERROR_COUNT" -eq 0 ]; then
              echo "âœ… **PASS** - No ESLint errors detected" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **FAIL** - $ERROR_COUNT error(s), $WARN_COUNT warning(s)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "<details><summary>Error Details (first 10)</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep "error" eslint.log | head -10 >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ **SKIPPED** - ESLint log not found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Coverage Guard Summary
          echo "### ðŸ§ª Test Coverage Guard" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.coverage.outputs.status }}" == "skipped" ]; then
            echo "â­ï¸ **SKIPPED** - ${{ steps.coverage.outputs.message }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "_Current Phase: Phase ${{ steps.coverage.outputs.phase }} (Pre-MVP, 0-100 users)_" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.coverage.outputs.status }}" == "pass" ]; then
            echo "âœ… **PASS** - All coverage thresholds met (Phase ${{ steps.coverage.outputs.phase }})" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.coverage.outputs.status }}" == "fail" ]; then
            echo "âŒ **FAIL** - Coverage below threshold (Phase ${{ steps.coverage.outputs.phase }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **ERROR** - Coverage test encountered an error" >> $GITHUB_STEP_SUMMARY
          fi

          # Coverage metrics table (only if tests ran)
          if [ -n "${{ steps.coverage.outputs.lines }}" ] && [ "${{ steps.coverage.outputs.status }}" != "skipped" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY

            # Determine threshold based on phase
            if [ "${{ steps.coverage.outputs.phase }}" == "2" ]; then
              LINES_THRESH=40
              BRANCHES_THRESH=35
              FUNCTIONS_THRESH=40
              STATEMENTS_THRESH=40
            else
              LINES_THRESH=80
              BRANCHES_THRESH=75
              FUNCTIONS_THRESH=80
              STATEMENTS_THRESH=80
            fi

            echo "| Metric | Current | Threshold | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|---------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Lines | ${{ steps.coverage.outputs.lines }}% | ${LINES_THRESH}% | $([ $(echo '${{ steps.coverage.outputs.lines }} >= '${LINES_THRESH} | bc -l) -eq 1 ] && echo 'âœ…' || echo 'âŒ') |" >> $GITHUB_STEP_SUMMARY
            echo "| Branches | ${{ steps.coverage.outputs.branches }}% | ${BRANCHES_THRESH}% | $([ $(echo '${{ steps.coverage.outputs.branches }} >= '${BRANCHES_THRESH} | bc -l) -eq 1 ] && echo 'âœ…' || echo 'âŒ') |" >> $GITHUB_STEP_SUMMARY
            echo "| Functions | ${{ steps.coverage.outputs.functions }}% | ${FUNCTIONS_THRESH}% | $([ $(echo '${{ steps.coverage.outputs.functions }} >= '${FUNCTIONS_THRESH} | bc -l) -eq 1 ] && echo 'âœ…' || echo 'âŒ') |" >> $GITHUB_STEP_SUMMARY
            echo "| Statements | ${{ steps.coverage.outputs.statements }}% | ${STATEMENTS_THRESH}% | $([ $(echo '${{ steps.coverage.outputs.statements }} >= '${STATEMENTS_THRESH} | bc -l) -eq 1 ] && echo 'âœ…' || echo 'âŒ') |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Performance Guard Summary
          echo "### âš¡ Performance Budget Guard" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.perf.outputs.status }}" == "pass" ]; then
            echo "âœ… **PASS** - Extraction time within budget" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.perf.outputs.status }}" == "fail" ]; then
            echo "âŒ **FAIL** - Extraction time exceeds threshold" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **SKIPPED** - Performance test did not run" >> $GITHUB_STEP_SUMMARY
          fi

          # Performance metrics table
          if [ -n "${{ steps.perf.outputs.metric }}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Extraction Time | ${{ steps.perf.outputs.metric }}ms | $([ '${{ steps.perf.outputs.status }}' == 'pass' ] && echo 'âœ…' || echo 'âŒ') |" >> $GITHUB_STEP_SUMMARY
            echo "| Threshold | ${{ steps.perf.outputs.threshold }}ms | - |" >> $GITHUB_STEP_SUMMARY
            echo "| Baseline | ${{ steps.perf.outputs.baseline }}ms | - |" >> $GITHUB_STEP_SUMMARY
            echo "| Delta | ${{ steps.perf.outputs.delta }}ms | $([ ${{ steps.perf.outputs.delta }} -le 0 ] && echo 'âœ… Better' || echo 'âš ï¸ Slower') |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Spec Audit Guard Summary
          echo "### ðŸ“‹ Spec Path Audit Guard" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.audit.outputs.status }}" == "pass" ]; then
            echo "âœ… **PASS** - All spec paths valid" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.audit.outputs.status }}" == "fail" ]; then
            echo "âŒ **FAIL** - Spec path mismatches detected" >> $GITHUB_STEP_SUMMARY
            if [ -f audit.log ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "<details><summary>Audit Details</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat audit.log >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ **SKIPPED** - Audit script not configured" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Note: All guards are currently **informational** (continue-on-error: true). They won't block PR merges._" >> $GITHUB_STEP_SUMMARY
