{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://payplan.app/schemas/email-extraction-output.schema.json",
  "title": "Email Extraction Output",
  "description": "Schema for BNPL email extraction output with confidence scoring (Phase B)",
  "type": "object",
  "required": ["items", "issues", "duplicatesRemoved"],
  "properties": {
    "items": {
      "type": "array",
      "description": "Extracted payment items from BNPL emails",
      "items": {
        "$ref": "#/definitions/Item"
      }
    },
    "issues": {
      "type": "array",
      "description": "Extraction errors and low-confidence warnings",
      "items": {
        "$ref": "#/definitions/Issue"
      }
    },
    "duplicatesRemoved": {
      "type": "integer",
      "description": "Count of duplicate items removed during deduplication",
      "minimum": 0
    }
  },
  "definitions": {
    "Item": {
      "type": "object",
      "description": "Single BNPL installment payment",
      "required": [
        "provider",
        "installment_no",
        "due_date",
        "amount",
        "currency",
        "autopay",
        "late_fee",
        "confidence"
      ],
      "properties": {
        "provider": {
          "type": "string",
          "description": "BNPL provider name",
          "enum": [
            "Klarna",
            "Affirm",
            "Afterpay",
            "PayPal Pay in 4",
            "Zip",
            "Sezzle"
          ]
        },
        "installment_no": {
          "type": "integer",
          "description": "Installment number (1-12)",
          "minimum": 1,
          "maximum": 12
        },
        "due_date": {
          "type": "string",
          "description": "Due date in ISO YYYY-MM-DD format",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
          "examples": ["2025-10-06", "2025-12-15"]
        },
        "amount": {
          "type": "number",
          "description": "Payment amount in USD",
          "minimum": 0.01,
          "examples": [25.00, 50.00, 125.50]
        },
        "currency": {
          "type": "string",
          "description": "Currency code (always USD in Phase B)",
          "const": "USD"
        },
        "autopay": {
          "type": "boolean",
          "description": "True if autopay is enabled for this payment"
        },
        "late_fee": {
          "type": "number",
          "description": "Late fee amount in USD (0 if no late fee)",
          "minimum": 0,
          "examples": [0, 7.00, 10.00]
        },
        "confidence": {
          "type": "number",
          "description": "Extraction confidence score (0-1)",
          "minimum": 0,
          "maximum": 1,
          "examples": [0.35, 0.60, 0.80, 1.00]
        }
      }
    },
    "Issue": {
      "type": "object",
      "description": "Extraction error or low-confidence warning",
      "required": ["id", "snippet", "reason"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for React keys",
          "pattern": "^issue-\\d+-\\d+$",
          "examples": ["issue-1727888400000-0", "issue-1727888400000-1"]
        },
        "snippet": {
          "type": "string",
          "description": "First 100 chars of problematic email (PII-redacted)",
          "maxLength": 100,
          "examples": [
            "From: [EMAIL] Payment [AMOUNT] due...",
            "Payment reminder for [NAME]..."
          ]
        },
        "reason": {
          "type": "string",
          "description": "Error message or low-confidence reason",
          "examples": [
            "Provider not recognized",
            "Amount not found. Ensure email contains text like \"Payment: $25.00\"",
            "Due date not found. Please ensure email contains text like \"Due: 10/6/2025\""
          ]
        },
        "fieldHints": {
          "type": "array",
          "description": "Specific missing/unclear fields for low-confidence items",
          "items": {
            "type": "string",
            "enum": [
              "Provider not recognized",
              "Due date not found",
              "Amount not found",
              "Installment number unclear",
              "Autopay status unclear"
            ]
          }
        }
      }
    }
  },
  "examples": [
    {
      "items": [
        {
          "provider": "Afterpay",
          "installment_no": 1,
          "due_date": "2025-10-06",
          "amount": 25.00,
          "currency": "USD",
          "autopay": false,
          "late_fee": 7.00,
          "confidence": 1.0
        },
        {
          "provider": "PayPal Pay in 4",
          "installment_no": 2,
          "due_date": "2025-10-15",
          "amount": 50.00,
          "currency": "USD",
          "autopay": true,
          "late_fee": 0,
          "confidence": 1.0
        }
      ],
      "issues": [
        {
          "id": "issue-1727888400000-0",
          "snippet": "From: [EMAIL] Payment reminder...",
          "reason": "Provider not recognized",
          "fieldHints": ["Provider not recognized"]
        }
      ],
      "duplicatesRemoved": 1
    }
  ]
}
